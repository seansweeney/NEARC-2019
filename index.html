<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Migrating AGOL User Accounts Using the ArcGIS API for Python</title>

	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/moon.css">

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="lib/css/zenburn.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>

	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

	<style type="text/css">
		.reveal pre {
    		font-size: 0.5em;
			box-shadow: none;
		}
		.reveal h3, .reveal h4 {
			text-transform: none;
		}
		.reveal pre code {
			max-height: initial;
			tab-size: 4;
		}
	</style>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<h2>
					<p>Migrating AGOL User Accounts Using the ArcGIS API for Python</p>
				</h2>
				<p>Sean Sweeney, GIS Senior Programmer Analyst</p>
				<p>City of Cambridge, MA</p>
				<small>
					<p>NEARC - Newry, ME</p>
					<p>October 21, 2019</p>
				</small>
				<aside class="notes">
					<strong>Abstract:</strong>
					<p>Cambridge is moving the majority of our ArcGIS Online users from AGOL logins to enterprise logins. Our goal is to 
						move users in a controlled manner - not only their content, but their profile and other aspects of their AGOL identity - 
						from their old AGOL login to their new enterprise account.</p>

						<p>I'll demonstrate some of the components of the ArcGIS API for Python we're using to accomplish this, point out a few 
						curveballs we've run into along the way, and also show final Python script that (mostly) automates the process.</p>
					</p>
				</aside>
			</section>
			<section>
				<h3>Why?</h3>
				<ul>
					<li>
						One login
					</li>
					<li>
						Simplified management
					</li>
					<li>
						Enforce password policy
					</li>
					<li>
						Better access control
					</li>
				</ul>
				<aside class="notes">
					<ul>
							<li>
								One login - Users don't have to remember a separate username and login for AGOL.
							</li>
							<li>
								Enforce password policy - The city login is subject to password policies that aren't available on AGOL, making it more secure.
							</li>
							<li>
								Simplified management - Users can be managed through an Active Directory group.
							</li>
							<li>
								Better access control - When people leave the city and their city account is disabled, they automatically lose access to our AGOL organization.
							</li>
						</ul>
				</aside>
			</section>
			<section>
				<h3>What?</h3>
				<ul>
					<li>
						Profile
					</li>
					<li>
						Folders
					</li>
					<li>
						Items
					</li>
					<li>
						Groups
					</li>
					<li>
						Role
					</li>
					<li>
						Credits
					</li>
					<li>
						Esri access
					</li>
				</ul>
				<aside class="notes">
					Esri has ways through the UI to move a user's content to another user, but we wanted to move everything about the use to the new account.
				</aside>
			</section>
			<section>
				<section>
					<h3>Connect to ArcGIS Online</h3>
					<pre>
<code class="python" data-line-numbers># Get username and password
# TODO: incorporate SSO login
username = input('Connection username: ')
password = getpass(prompt='Connection password: ')

# Connect to ArcGIS Online
try:
	gis = GIS("https://arcgis.com/", username, password)
except:
	print(sys.exc_info()[0])
	exit(1)
</code>
					</pre>
					<aside class="notes">
						<p>SSO login from the script was working for a while but has since stopped working for me.  I'm using my old AGOL account with admin 
						access to run the script in the meantime.</p>
						
						<p>For more info about SSO access from a script see 
						<a href="https://developers.arcgis.com/python/guide/working-with-different-authentication-schemes/#User-authentication-with-OAuth-2.0" target="_blank">User authentication with OAuth 2.0</a>.</p>
					</aside>
				</section>
				<section>
					<h3>Connect to ArcGIS Online</h3>
					<pre>
<code class="python" data-line-numbers="8"># Get username and password
# TODO: incorporate SSO login
username = input('Connection username: ')
password = getpass(prompt='Connection password: ')

# Connect to ArcGIS Online
try:
	gis = GIS("https://arcgis.com/", username, password)
except:
	print(sys.exc_info()[0])
	exit(1)
</code>
					</pre>
					<aside class="notes">
						Note you don't have to specify the organization URL if your login user only belongs to one organization.
					</aside>
				</section>
				<section>
					<h3>Connect to ArcGIS Online</h3>
					<pre>
<code data-line-numbers="8"># Get username and password
# TODO: incorporate SSO login
username = input('Connection username: ')
password = getpass(prompt='Connection password: ')

# Connect to ArcGIS Online
try:
	gis = GIS(username=username,password=password)
except:
	print(sys.exc_info()[0])
	exit(1)
</code>
					</pre>
					<aside class="notes">
						In fact, you don't need to specify any URL - it defaults to https://arcgis.com.
					</aside>
					</section>
			</section>
			<section>
				<h3>Get pointers to old and new users</h3>
				<pre>
<code class="python"># Get pointers to old and new users
agol_username = input('AGOL (old) username: ')

sso_username = input('SSO (new) username: ')

try:
	agol_user = gis.users.get(agol_username)
	sso_user = gis.users.get(sso_username)
except exceptions.Exception as e:
	print("Unexpected error: {}".format(e))
	raise e
</code>
				</pre>
				<aside class="notes">
					<p>
						The first step is to get the user objects for the old and new users. This step assumes the new user is already created. 
						I have written the code to create the user but haven't gotten it integrated into the script yet.
					</p>
				</aside>
			</section>
			<section>
			<h3>Profile Items</h3>
				<img src='images/profile_items.png' alt='Profile items' style="border:none;" />
				<aside class="notes">
					Some of the profile items are created automatically when the new account is created. Some things are not applicable or can't be
					set. The rest can be transferred over using the API.
				</aside>
			</section>
			<section>
					<h3>Profile Items</h3>
					<h4>User.update()</h4>
					<section>
					<pre>
<code data-line-numbers="3-12">agol_thumbnail_download = agol_user.download_thumbnail(os.getenv('TEMP'))

sso_user.update(access=agol_user.access, 
		preferred_view=agol_user.preferredView, 
		description=agol_user.description, 
		tags=agol_user.tags, 
		thumbnail=agol_thumbnail_download, 
		culture=agol_user.culture, 
		region=agol_user.region, 
		fullname=agol_user.fullName, 
		first_name=agol_user.firstName, 
		last_name=agol_user.lastName
		)
						</code>
					</pre>
					<aside class="notes">
						<p>Most of the basic profile items are handled by the <a href="https://developers.arcgis.com/python/api-reference/arcgis.gis.toc.html#arcgis.gis.User.update" target="_blank">user.update()</a> method.</p>
					</aside>
				</section>
				<section>
					<pre>
<code data-line-numbers="1,7">agol_thumbnail_download = agol_user.download_thumbnail(os.getenv('TEMP'))

sso_user.update(access=agol_user.access, 
		preferred_view=agol_user.preferredView, 
		description=agol_user.description, 
		tags=agol_user.tags, 
		thumbnail=agol_thumbnail_download, 
		culture=agol_user.culture, 
		region=agol_user.region, 
		fullname=agol_user.fullName, 
		first_name=agol_user.firstName, 
		last_name=agol_user.lastName
		)
						</code>
					</pre>
					<aside class="notes">
							<p>Although the <em>thumbnail</em> input to <em>user.update()</em> is supposed to be able to take a URL, I found that didn't work for me so I 
							   download the thumbnail to my TEMP directory and upload it from there to the new account.</p>
						</aside>
					</section>
				<section>
					<pre>
<code data-line-numbers="10-12">agol_thumbnail_download = agol_user.download_thumbnail(os.getenv('TEMP'))
	
sso_user.update(access=agol_user.access, 
		preferred_view=agol_user.preferredView, 
		description=agol_user.description, 
		tags=agol_user.tags, 
		thumbnail=agol_thumbnail_download, 
		culture=agol_user.culture, 
		region=agol_user.region, 
		fullname=agol_user.fullName, 
		first_name=agol_user.firstName, 
		last_name=agol_user.lastName
		)
</code>
					</pre>
					<aside class="notes">
						For some reason <em>fullName</em>, <em>firstName</em>, and <em>lastName</em> are three separate properties.
					</aside>
				</section>
			</section>
			<section>
				<h3>Profile Items</h3>
				<h4>Role</h4>
				<section>
					<pre>
<code class="python" data-line-numbers="1-7">builtin_roles = ['org_user', 'org_publisher', 'org_admin',
					'viewer', 'view_only', 'viewplusedit']
if (agol_user.role in builtin_roles):
	# Built-in user role (org_user, org_publisher, org_admin, 
	#                     viewer, view_only, viewplusedit)
	# Assign directly
	sso_user.update_role(role=agol_user.role)
else:
	# Custom role - first get role object from RoleManager
	role = gis.users.roles.get_role(agol_user.roleId)
	sso_user.update_role(role=role)
</code>
					</pre>
					<aside class="notes">
							<p>For built-in user roles (<em>org_user, org_publisher, org_admin, viewer, view_only, viewplusedit</em>) you can just pass the <em>role</em> property to <em>update_role()</em>.</p>
					</aside>
				</section>
				<section>
					<pre>
<code class="python" data-line-numbers="8-11">builtin_roles = ['org_user', 'org_publisher', 'org_admin',
					'viewer', 'view_only', 'viewplusedit']
if (agol_user.role in builtin_roles):
	# Built-in user role (org_user, org_publisher, org_admin, 
	#                     viewer, view_only, viewplusedit)
	# Assign directly
	sso_user.update_role(role=agol_user.role)
else:
	# Custom role - first get role object from RoleManager
	role = gis.users.roles.get_role(agol_user.roleId)
	sso_user.update_role(role=role)
</code>
				</pre>
				<aside class="notes">
						<p>For custom roles you have to get the role object from the <a href="https://developers.arcgis.com/python/api-reference/arcgis.gis.toc.html#rolemanager" target="_blank">RoleManager</a> 
							static class (via <em>gis.users.roles</em>).</p>
						<p>You can't just use the second method for all of them because the built-in roles don't exist in the <em>RoleManager</em>.</p>
				</aside>
			</section>
			</section>
			<section>
				<h3>Profile Items</h3>
				<h4>Regionalization & Esri Access</h4>
				<pre>
<code class="python" data-line-numbers># Regionalization #
sso_user.units = agol_user.units
sso_user.cultureFormat = agol_user.cultureFormat
			
# Esri access #
if (agol_user.esri_access == 'both'):
	sso_user.esri_access = True
</code>
				</pre>
				<aside class="notes">
					<p>I assumed the regionalization settings would be the same for everyone in my organization, but there are some slight differences. 
						I'm not sure why they don't all default to the same thing, though it may have to do with when each account was created.</p>
					<p>For <a href="https://esri.github.io/arcgis-python-api/apidoc/html/arcgis.gis.toc.html#arcgis.gis.User.esri_access" target="_blank">esri_access</a> there 
					   is a separate getter and setter.  From the help: "When getting, will return a string describing the current userâ€™s esri access. When setting, supply a bool to enable or 
					   disable esri_access for that user (Administrator privileges required)"</p>
					   <p>For us, the get options are <em>arcgisonly</em> or <em>both</em>.</p> If the old user has <em>both</em> then set the new user's value to <em>True</em>.
				</aside>
			</section>
			<section>
				<h3>Groups</h3>
				<section>
					<pre>
<code class="python" data-line-numbers="1-4">for group in agol_user.groups:
	if (group.owner == agol_username):
		print('Changing ownership: ' + group.title)
		group.reassign_to(sso_username)
	else:
		print('Joining: ' + group.title)
		group.add_users([sso_username])	
</code>
					</pre>
					<aside class="notes">
						<p>For groups there are two scenarios.</p>
						<p>If the original user owns the group, then ownership needs to be transferred to the new user.</p>
					</aside>
				</section>
				<section>
					<pre>
<code class="python" data-line-numbers="5-8">for group in agol_user.groups:
	if (group.owner == agol_username):
		print('Changing ownership: ' + group.title)
		group.reassign_to(sso_username)
	else:
		print('Joining: ' + group.title)
		group.add_users([sso_username])	
</code>
					</pre>
					<aside class="notes">
						<p>Otherwise, just make the new user a member of the group.</p>
					</aside>
				</section>
			</section>
			<section>
				<h3>Content</h3>
				<section>
					<h4>Share and update capabilities</h4>
					<img src='images/what_can_members_update_tip.png' alt='What can members update?' style="border:none;" />
					<aside class="notes">
						<p>Groups created with <em>All items</em> selected for <em>What items in the group can its members update?</em> will have items that can be updated.</p>
						<p>Items in groups with this setting cannot change ownership. You must un-share the item from the group, move it, then re-share.</p>
					</aside>
				</section>
				<section>
					<h4>item_reassign()</h4>
					<pre>
<code class="python" data-line-numbers=1-3>all_groups = gis.groups.search('-')
update_groups = [group.title for group in all_groups 
		if 'updateitemcontrol' in group.capabilities]
#...
item_groups = [group.title for group in item.shared_with['groups']]
item_update_groups = [title for title in item_groups 
			if title in update_groups]
if item_update_groups:
	item.unshare(item_update_groups)
	
try:
	item.reassign_to(user, target_folder=folder)
except Exception as e:
	print(e)
	raise e

if item_update_groups:
	item.share(groups=item_update_groups, allow_members_to_edit=True)
</code>
					</pre>
					<aside class="notes">
						<p>
							First, I get a list of all the groups that have this setting. The <em>group.capabilities</em> property contains a list of capability values. 
							If one of these is <em>updateitemcontrol</em> then the group has share and update capabilities.
						</p>
					</aside>
				</section>
				<section>
					<h4>item_reassign()</h4>
					<pre>
<code class="python" data-line-numbers=5-9>all_groups = gis.groups.search('-')
update_groups = [group.title for group in all_groups 
		if 'updateitemcontrol' in group.capabilities]
#...
item_groups = [group.title for group in item.shared_with['groups']]
item_update_groups = [title for title in item_groups 
			if title in update_groups]
if item_update_groups:
	item.unshare(item_update_groups)
	
try:
	item.reassign_to(user, target_folder=folder)
except Exception as e:
	print(e)
	raise e

if item_update_groups:
	item.share(groups=item_update_groups, allow_members_to_edit=True)
</code>
					</pre>
					<aside class="notes">
						<p>
							Next, I compare the list of groups that have the setting against a list of the current item's groups. If there
							is a match, then I unshare the item from the groups that match.
						</p>
						<p>
							Note that <em>item.unshare()</em> takes a list of groups as input, so the item can be unshared from all the target
							groups with one call.
						</p>
					</aside>
				</section>
				<section>
					<h4>item_reassign()</h4>
					<pre>
<code class="python" data-line-numbers=11-15>all_groups = gis.groups.search('-')
update_groups = [group.title for group in all_groups 
		if 'updateitemcontrol' in group.capabilities]
#...
item_groups = [group.title for group in item.shared_with['groups']]
item_update_groups = [title for title in item_groups 
			if title in update_groups]
if item_update_groups:
	item.unshare(item_update_groups)
	
try:
	item.reassign_to(user, target_folder=folder)
except Exception as e:
	print(e)
	raise e

if item_update_groups:
	item.share(groups=item_update_groups, allow_members_to_edit=True)
</code>
					</pre>
					<aside class="notes">
						Then move the item to the appropriate folder in the new user's account.
					</aside>
				</section>
				<section>
					<h4>item_reassign()</h4>
					<pre>
<code class="python" data-line-numbers=17-18>all_groups = gis.groups.search('-')
update_groups = [group.title for group in all_groups 
		if 'updateitemcontrol' in group.capabilities]
#...
item_groups = [group.title for group in item.shared_with['groups']]
item_update_groups = [title for title in item_groups 
			if title in update_groups]
if item_update_groups:
	item.unshare(item_update_groups)
	
try:
	item.reassign_to(user, target_folder=folder)
except Exception as e:
	print(e)
	raise e

if item_update_groups:
	item.share(groups=item_update_groups, allow_members_to_edit=True)
</code>
					</pre>
					<aside class="notes">
						<p>
							Finally, share the item back to the groups it was unshared from, if any.
						</p>
						<p>
							Note that <em>item.share()</em> takes a list of groups as input, so the item can be shared from all the target
							groups with one call.
						</p>
					</aside>
				</section>
				<section>
					<h4>Root Content</h4>
					<img src='images/root_folder.png' alt='Root folder' style="border:none;" />
					<aside class="notes">
						<p>
							Root items and items that are in folders need to be handled separately.
						</p>
						<p>
							On ArcGIS Online the root folder is indicated by a home icon and your username in the <em>Folders</em> list.
						</p>
					</aside>
				</section>
				<section>
					<h4>Root Content</h4>
					<pre>
<code class="python" data-line-numbers=2># Root Content #
agol_root_items = agol_user.items()
print('Folder: Root')
for item in agol_root_items:
	try:
		print('* Moving: ' + item.title)
		item_reassign(item=item, user=sso_username, folder=None)
	except Exception as e:
		print(e)
		print("Item may have already been assigned to user.")
</code>
					</pre>
					<aside class="notes">
						<p>
							Calling <em>user.items()</em> with no argument returns all the items in the user's root folder.
						</p>
					</aside>
				</section>
				<section>
					<h4>Root Content</h4>
					<pre>
<code class="python" data-line-numbers=4-10># Root Content #
agol_root_items = agol_user.items()
print('Folder: Root')
for item in agol_root_items:
	try:
		print('* Moving: ' + item.title)
		item_reassign(item=item, user=sso_username, folder=None)
	except Exception as e:
		print(e)
		print("Item may have already been assigned to user.")
</code>
					</pre>
					<aside class="notes">
						<p>
							I then loop over those items and reassign them using my <em>item_reassign()</em> function and setting <em>folder=None</em>.
						</p>
					</aside>
				</section>
				<section>
					<h4>Folder Content</h4>
					<pre>
<code class="python" data-line-numbers=1-3>agol_folders = agol_user.folders
sso_folders = sso_user.folders
sso_foldernames = [folder['title'] for folder in sso_folders]
for agol_folder in agol_folders:
	gis.content.create_folder(agol_folder['title'], sso_username)
	agol_folder_items = agol_user.items(folder=agol_folder['title']) 
	for item in agol_folder_items:
		print('* Moving ' + item.title)
		item_reassign(item=item, user=sso_username, 
				folder=agol_folder['title'])
</code>
					</pre>
					<aside class="notes">
						For items in folders I first get a list of folder names.
					</aside>
				</section>	
				<section>
					<h4>Folder Content</h4>
					<pre>
<code class="python" data-line-numbers=4-5>agol_folders = agol_user.folders
sso_folders = sso_user.folders
sso_foldernames = [folder['title'] for folder in sso_folders]
for agol_folder in agol_folders:
	gis.content.create_folder(agol_folder['title'], sso_username)
	agol_folder_items = agol_user.items(folder=agol_folder['title']) 
	for item in agol_folder_items:
		print('* Moving ' + item.title)
		item_reassign(item=item, user=sso_username, 
				folder=agol_folder['title'])
</code>
					</pre>
					<aside class="notes">
						I create the folder in the new account.
					</aside>
				</section>	
				<section>
					<h4>Folder Content</h4>
					<pre>
<code class="python" data-line-numbers=4,6-10>agol_folders = agol_user.folders
sso_folders = sso_user.folders
sso_foldernames = [folder['title'] for folder in sso_folders]
for agol_folder in agol_folders:
	gis.content.create_folder(agol_folder['title'], sso_username)
	agol_folder_items = agol_user.items(folder=agol_folder['title']) 
	for item in agol_folder_items:
		print('* Moving ' + item.title)
		item_reassign(item=item, user=sso_username, 
				folder=agol_folder['title'])
</code>
					</pre>
					<aside class="notes">
						Then I get a list of the items to move, loop over them, and reassign them just like the root items, this time setting the appropriate folder name.
					</aside>
				</section>	
			</section>
			<section>
					<h3>Things we can't do</h3>
					<section>
						<h4>Favorites</h4>
						<pre>
<code class="python" data-line-numbers>agol_fav_items = gis.groups.get(agol_user.favGroupId)
agol_favs = [content.title for content in agol_fav_items.content()]
if agol_favs:
	print("Old User's Favorites".center(40,'-'))
	print(agol_favs)			
</code>
						</pre>
						<aside class="notes">
							<p>
								I could not find a way to set favorites in the API at this time. Luckily most of my users don't have any set. The script 
								displays a list of favorites at the end so that the user can re-set them manually if they want to.
							</p>
						</aside>
					</section>
					<section>
						<h4>Credits</h4>
						<pre>
<code class="python" data-line-numbers>print('Old user account had {} credits'.format(agol_user.assignedCredits))
</code>
						</pre>
						<aside class="notes">
							<p>
								At the time I originally wrote the script there was no way to set the credit limit and current credit balance
								using the API. I had to print these out and fix them manually afterwards. As I was putting together this 
								presentation, I found a document that suggests that this can now be done in the latest version of the API, 
								but I didn't have time to update the code.
							</p>
							<p>
								See <a href="https://developers.arcgis.com/python/api-reference/arcgis.gis.admin.html?#creditmanager" target="_blank">CreditManager</a> 
								for more details.
							</p>
						</aside>
					</section>
					<section>
						<h4>Licenses</h4>
						<pre>
<code class="python" data-line-numbers># Licenses #
# Not yet available in AGOL (Enterprise only) #
# print("Old User's Licenses".center(40,'-'))
# print(agol_user.provisions)
</code>
						</pre>
						<aside class="notes">
							<p>
								Managing user licenses has not yet been added to the AGOL API, but it is available in Enterprise so I assume it's coming soon.
							</p>
							<P>
								See <a href="https://developers.arcgis.com/python/api-reference/arcgis.gis.admin.html?#license" target="_blank">License</a> for more details.
							</P>
						</aside>
					</section>
					<section>
						<h4>Link your ArcGIS accounts</h4>
							Requires authenticating to linked account.
							<aside class="notes">
								<p>
									Linking to other ArcGIS accounts requires authenticating to the linked account, which is something the script will never be able to do.
								</p>
								<p>
									This needs to be done manually by the user after the  move. Almost none of our users use this feature.
								</p>
							</aside>
					</section>	
				</section>
	
			<section>
				<h1>Demos</h1>
			</section>
			<section>
				<h4>More Info</h4>
				<h5>Me</h5>
				<small>
					<p>Email: <a href="mailto:ssweeney@cambridgema.gov" style='color:#f48341'>ssweeney@cambridgema.gov</a>
					Twitter: <a target='_blank' href='https://twitter.com/hiker4k' style='color:#f48341'>@hiker4k</a>
					GitHub: <a target='_blank' href='https://github.com/seansweeney' style='color:#f48341'>seansweeney</a></p>
					<p>This Presentation: <a target='_blank' href='https://github.com/seansweeney/NEARC-2019' style='color:#f48341'>https://github.com/seansweeney/NEARC-2019</a></p>
				</small>
				<h5>Us</h5>
				<small>
					<p>Web: <a target='_blank' href='http://cambridgema.gov/gis' style='color:#418d41'>http://cambridgema.gov/gis</a>
					Twitter: <a target='_blank' href='https://twitter.com/cambridgegis' style='color:#418d41'>@CambridgeGIS</a></p>
				</small>
			</section>
		</div>
	</div>

	<script src="lib/js/head.min.js"></script>
	<script src="js/reveal.js"></script>

	<script>
		// More info about config & dependencies:
		// - https://github.com/hakimel/reveal.js#configuration
		// - https://github.com/hakimel/reveal.js#dependencies
		Reveal.initialize({
			showNotes: false,
			transition: 'none',
			history: 'true',
			dependencies: [
				// { src: 'plugin/markdown/marked.js' },
				// { src: 'plugin/markdown/markdown.js' },
				{ src: 'plugin/notes/notes.js', async: true },
				{ src: 'plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } }
			]
		});
	</script>
</body>

</html>